<!DOCTYPE html>
<html lang="zh-cn">
 
<head>
	<meta charset="utf-8">
	<base href="../../">
	<title>编辑插入接口 - Powered By jiadao</title>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
	<meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=8,IE=9,IE=10" />
	<meta http-equiv="Expires" content="0"><meta http-equiv="Cache-Control" content="no-cache"><meta http-equiv="Cache-Control" content="no-store">
	<script src="js/jquery-1.8.3.min.js" type="text/javascript"></script>
	<link href="css/bootstrap.min.css" type="text/css" rel="stylesheet" />

	<script src="js/bootstrap.min.js"  type="text/javascript"></script>
	<script src="js/jquery.htmlClean.js"  type="text/javascript"></script>
	<link href="css/jquery.dataTables.min.css" type="text/css" rel="stylesheet" />
	<script src="js/jquery.dataTables.min.js" type="text/javascript"></script> 
	
	<script src="js/Sortable.js" type="text/javascript"></script>
	<script src="js/common.js" type="text/javascript"></script>
	<script src="js/vue.js"></script>
	<style>
		.table-column-select{
			width: 100px;
		}

		table.dataTable.nowrap th, table.dataTable.nowrap td{
			white-space: normal !important;
		}
		.placeholder{
			height: 50px;
			border: gray solid 1px;
			background-color: gray;
		}
	</style>
</head>
<body>
		<div id="app">
			<div class="container">
				
				<h2>编辑插入接口</h2>
				<div class="row-fluid">
					<div class="span12">
						<form  class="form-inline" > 
							<fieldset>
								<legend>接口基本信息</legend>
							
								<div class="form-group">
									<label>api名称:</label>
									<input id="name_cn" name="nameCN" class="form-control" placeholder="请填写接口名称"  type="text" v-model="name"/>
								</div>
								<div class="form-group">
									<label  >api说明:</label>
									<input id="comments" name="comments" class="form-control required"  placeholder="请填写接口说明"  type="text"  v-model="comment" maxlength="200"/>
								</div>
								<div class="form-group">
									<label>api路径:</label>
									<input id="api_name" name="name" class="form-control required"  placeholder="请填写接口地址"   type="text" v-model="path" maxlength="200"/>
									<span>api地址为: /api/save/{{path}}</span>
								</div>
							</fieldset>
						</form>
					</div>
				</div>
				
				<div class="row-fluid">
					<div class="span12">
						<h3>
							选择要导入的表
						</h3>
						
						<table class="table table-condensed table-bordered">
							<thead>
								<tr>
									<th> 表名
									</th>
									<th> 中文注释
									</th>
								</tr>
							</thead>
							<tbody>
								
									<td>
										<select v-model="genSql"   class="form-control">
											<option v-for=" (table, idx) in all_tables" :value="table" title="">{{table}}</option>
										</select>
									</td>
									<td>{{tableNameCn}}
									</td>
								
							</tbody>
						</table>
						<button class="btn btn-primary" type="button" @click="loadSelectTables" >载入表信息</button>
					</div>
				</div>
				
				<div class="row-fluid">
					<div class="span12">
						<h3> 设置表单字段 </h3>
						<table id="result_table" class="table table-condensed table-bordered">
							<thead>
								<tr>
									<th>是否显示</th>
									<th>表名</th>
									<th> 字段名 </th>
									<th> 中文注释
									</th>
									<!-- <th> 显示顺序
									</th> -->
								</tr>
							</thead>
							<tbody>
								<tr v-for=" (item, index) in resultColumns" :key="item.column_name_alias" >
									<td>
										<input v-if="item.column_name != 'id'" type="checkbox" v-model="item.status" />
									</td>
									<td>{{item.table_name}}</td>
									<td>{{item.column_name}}</td>
									<td>
										<input type="text" v-model="item.column_name_cn" >
									</td>
									<!-- <td>
										{{item.column_index}}
									</td> -->
								</tr>
							</tbody>
						</table>
					</div>
				</div>
				
				<!-- <button class="btn btn-primary btn-lg" @click="configFormHtml">配置自定义表单</button> -->

				<button class="btn btn-primary btn-lg" type="button" @click="createApi">保存api</button>
						
				<div class="row-fluid">
					<div class="span12">
						
						<h3>请求url</h3>
						<code>http://{{host}}/api/save/{{path}}</code>
						<h3>请求方式：</h3>
						<code>POST</code>
						
						
						
						<table class="table table-condensed table-bordered">
							<thead>
								<tr>
									<th> 参数名
									</th>
									<th> 说明
									</th>
									<th> 测试值
									</th>
								</tr>
							</thead>
							<tbody>
								<tr v-for=" (value, name) in insertColumns" >
									<td>{{value.column}}</td>
									<td>{{value.name}}</td>
									<td><input v-model="value.value" type="text" class="form-control"   placeholder="请输入查询内容">
									</td>
								</tr>
								
							</tbody>
						</table>
						<button type="button" class="btn btn-success"  @click="saveTest">测试表单提交</button>
				

					</div>
				</div>
				<div class="row-fluid">
					<div class="span12">
						
					<h3>接口返回结果格式</h3>
					<code style='white-space: pre-wrap;'>{{resultJson}}</code>
						
					</div>
				</div>

			
		
			<!-- 按钮触发模态框 -->
			<!-- 模态框（Modal） -->
			<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
				<div class="modal-dialog" style="width:1100px" >
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
							<h4 class="modal-title" id="myModalLabel">设置表单</h4>
						</div>
						<div class="modal-body">
								<div class="row">
									<form role="form" class="form-inline"  style="margin: 15px 30px;">
										<fieldset>
											<legend>设置表单参数</legend>
											<div class="col-md-4">
												<label style="width: 100px;text-align:left;padding-left:10px">设置表单方向</label>
												<select v-model="formDirection"   class="form-control">
													<option value="form-horizontal" title="">垂直</option>
													<option value="form-inline"  title="">水平</option>
												</select>
											</div>
											<div class="col-md-4">
												<label style="width: 100px;text-align:left;padding-left:10px">设置表单列数</label>
												<select v-model="inputClass"   class="form-control">
													<option value="col-md-6" title="">2列</option>
													<option value="col-md-4"  title="">3列</option>
													<option value="col-md-3"  title="">4列</option>
												</select>
											</div>
										</fieldset>
									</form>
								</div>
								<div  class="row">
									<!-- formDirection -->
									<!-- <form id="addFromHtml"  role="form" class="form-inline"> -->
									
									<h3  style="margin:15px 30px;">表单预览</h3>
									<div  id="addFromHtml" >
										<form role="form" :class="formDirection" style="margin:15px 30px;">
											<div v-for=" (value, name) in insertColumns" :class="value.class_name">
												<label style="width: 100px;text-align:left;padding-left:10px">{{value.name}}</label>
												<input v-model="value.value" type="text" class="form-control"   placeholder="请输入内容">
											</div>
										</form>
									</div>
								</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
							<button type="button" class="btn btn-primary copy-btn"   @click="genFormHtml">生成表单代码（需保存api后生效）</button>
						</div>
					</div><!-- /.modal-content -->
				</div><!-- /.modal -->
			</div>

			
			
		</div>

		</div>


    <script type="text/javascript">

	</script>

<script type="text/javascript">
	
	var index = 0;


	$(function  () {
		//结果表格拖拽排序功能
		const tbody = document.querySelector('#result_table tbody')
		Sortable.create(tbody, {
			onEnd({ newIndex, oldIndex }) {
				console.log(oldIndex+"===="+newIndex)
				if(newIndex == oldIndex){
					return
				}
				const currRow = apiData.resultColumns.splice(oldIndex, 1)[0]
				apiData.resultColumns.splice(newIndex, 0, currRow)
				apiData.resultColumns.forEach(function(column,index){
					// console.log(column)
					//排序后，重新设定序号
					column.column_index = index+1	
				})
				
			}
		})
		
	});

	</script>

	<script>
	var apiData ={
			id:0,
			name:'插入xx信息接口',
			path:'',
			comment:'插入xx信息接口',
			type:'save',
			//所有的表，不需要存储
			all_tables:[],
			//已选中的表
			// tables_info:[{name:'请选择',nameCN:'',alias:''}],
			// selectTableInfo:{},
			//已选中的表对应的列，不需要存储
			// select_table_columns:{},
			//select_fields:[],
			
			//tableJoins:[{left_table:'t_score',left_column:'student_code',join_type:'inner join',right_table:'t_student',right_column:'code'},
			//			{left_table:'t_score',left_column:'course_code',join_type:'inner join',right_table:'t_course',right_column:'code'}],
			//查询条件数组
			whereConditions:{},
			// insertColumns:[],
			//查询结果配置
			resultColumns:[],
			//table_name:'t_course',
			//test_arr : { 't_course':[ 'a','b','c']},
			genSql:'',
			tableNameCn:'',
			inputClass:'col-md-4',
			formDirection:'form-inline',
			formHtml:'' //自定义表单代码
	}
	
	var app = new Vue({
		el: '#app',
		data: apiData,

		mounted:function(){
			apiId = getUrlParam("id")
			if( typeof apiId != "undefined" && apiId != null ){
				apiData.id =  apiId
				$.ajax({
					type:"get",
					url:"api-gen/getApi",
					data:{apiId:apiId},
					success:function(ret){
						console.log(ret)
						if(ret.code == CODE_SUCCESS){
							result = ret.data
							
							result['whereConditions'] = $.parseJSON(result['whereConditions'])
							result['resultColumns'] = $.parseJSON(result['resultColumns'])
							$.extend(apiData,result)
							$('#api_name').attr("readonly","readonly")
						}
					}
				})
			}
			

			$.get('table/getTableNames',function(data){
				console.log(JSON.stringify(data))
				apiData.all_tables = data;
			},'json')

			
		},
		methods:{
			//添加一个表
			// addTable:function(){
			// 	app.tables_info.push({name:'',name_cn:'',alias:''})
			// 	// app.selectTableInfo['请选择'] = {nameCN:'',alias:''}
			// },

			sortIndex:function(){
				
			},

			//加载已选择的表
			loadSelectTables:function(){
				// select_tables = []
				// apiData.tables_info.forEach(function(item,index){
				// 	select_tables.push(item.name)
				// })
				$.ajax({
					type:"post",
					url:"table/getTableByNames",
					traditional:true,
					data:{tableNames:[apiData.genSql]},
					success:function(ret){
						//console.log(ret)
						if(ret.code == CODE_SUCCESS && ret.data.length > 0){
							count = 1//排序计数
							//清空已选中数据表
							// apiData.selectTableInfo = {}
							// apiData.tables_info = []
							// apiData.tableJoins = []
							apiData.resultColumns = []
							//赋值已选的表数据
							// apiData.select_table_columns = {}
							tableDatas = ret.data
							tableDatas.forEach(function(table,index){
								table_alias = String.fromCharCode(97+index)
								apiData.tableNameCn = table.nameCN
								//apiData.selectTableInfo[table.name] = {'name_cn':table.nameCN,'alias':table_alias}
								//apiData.tables_info.push({'name':table.name,'name_cn':table.nameCN,'alias':table_alias})
								//table_aliases[table.name] = table_alias
								//预置连接条件，将第一个表作为主表
								//apiData.tableJoins.push({left_table:tableDatas[0].name,left_column:'',join_type:'inner join',right_table:'',right_column:''})
								//apiData.select_table_columns[table.name] = table.columns
								table.columns.forEach(function(column,idx){
									column_name_alias = table_alias+'_'+column.name
									result_column = {	status:true,
														table_name:table.name,
														table_alias:table_alias,
														column_name:column.name,
														column_name_cn:column.nameCN,
														//column_name_alias:column_name_alias,
														column_name_alias:column.name,
														//column_type:'text',
														column_index:count,
														column_order:'',
														column_query_type:'',
														column_test_value:'',
														column_test_value2:''
													}
									apiData.resultColumns.push(result_column) 
									count += 1

									
								})
							})

							


						}
						else{
							console.log('加载失败'+select_tables)
						}
					}
				})
			},

			addJoin:function(){
				apiData.tableJoins.push({left_table:'',left_column:'',join_type:'',right_table:'',right_column:''})
			},

			deleteJoin:function(){

			},

			createApi:function(){
				//复制apiData对象到params
				if(apiData.name=="" || apiData.path==""){
					alert("api名称和地址必填")
					return
				}
				var params = $.extend(true, {}, apiData);
				delete params["all_tables"]

				params['whereConditions'] = JSON.stringify(params['whereConditions'])
				params['resultColumns'] = JSON.stringify(params['resultColumns'])
				$.ajax({
					type:'post',
					url:'api-gen/createApi',
					data:JSON.stringify(params),
					contentType:"application/json;charset=UTF-8",
					success:function(ret){
						console.log(ret);
						if(ret.code==CODE_SUCCESS){
							apiData.id = ret.data;
							alert('保存api成功')
							$('#api_name').attr("readonly","readonly")
						}
						else{
							alert('保存api失败：'+ret.msg)
						}
					},
					error:function () {
						alert('发生错误：')
					}
				});
			},

			saveTest:function()  {
				//组装查询条件
				jsonParams = {}
				app.insertColumns.forEach(function(item,index){
					jsonParams[item.column] = item.value
				})
				var params = {	
								tableName:apiData.genSql,
								jsonParam:JSON.stringify(jsonParams)
							 }
				$.ajax({
					type:'post',
					url:'api-gen/save',
					data:params,
					success:function(ret){
						console.log(ret);
						alert('插入成功')
					},
					error:function () {
						alert('发生错误：')
					}
				});
			},
			configFormHtml:function(){
				$('#myModal').modal('show')
			},
			genFormHtml:function(){
				var htmlOrig = $("#addFromHtml").html()
				var formatSrc = $.htmlClean(htmlOrig, {
								format: true,
								allowedAttributes: [
									["id"],
									["class"],
									["style"],
									["data-toggle"],
									["data-target"],
									["data-parent"],
									["role"],
									["data-dismiss"],
									["aria-labelledby"],
									["aria-hidden"],
									["data-slide-to"],
									["data-slide"]
								]
							});
				console.log(htmlOrig)
				console.log(formatSrc)
				apiData.formHtml = formatSrc
				
			}
		},
		computed:{
			//自动计算组装的sql
			host:function(){
				return window.location.hostname +':'+ window.location.port
			},
			insertColumns:function(){
				insert_columns = []
				count = 1
				apiData.whereConditions = {}
				apiData.resultColumns.forEach(function(column,index){
						//如果该列未选中  或者列名是id
						if(column.status == false || column.column_name=='id'){
							column.column_index=''
							return false
						}
						column.column_index = count
						count += 1
						class_name = apiData.inputClass
						if(apiData.formDirection == 'form-horizontal'){
							class_name = 'form-group'
						}
						insert_columns.push({column:column.column_name,name:column.column_name_cn,class_name:class_name})
						apiData.whereConditions[column.column_name] = {column:column.column_name,
																		name:column.column_name_cn,
																		opt:'='}
				})
				return insert_columns
			},
			resultJson: function(){
				var jsonObj = {code:'状态码：200表示成功',
								msg:'服务端返回信息',
								data:'插入成功的数据主键id'
								}
				return JSON.stringify(jsonObj, null, 2)
			}
		}
	})
</script>
</body>
</html>